---

include:
  - template: 'Workflows/MergeRequest-Pipelines.gitlab-ci.yml'

stages:
  - ðŸ§ª test
  - ðŸ“‹ lint
  - ðŸ— build
  - ðŸ“¦ publish
  - ðŸš€ deploy
  - ðŸ“£ release

variables:
  # Image
  UV_VERSION: "0.9.18"
  PYTHON_VERSION: "3.11"

  # App
  STATIC_SITE_PATH: "$CI_PROJECT_DIR/_site"

  # Task runner
  TASK_BIN: "uv run task"

  # Packaging
  PACKAGE_ACCESS_IDENTIFIER: "gitlab-ci"

  # Deployment
  DEPLOY_ANSIBLE_REPO: "gitlab.data.bas.ac.uk/station-data-management/ansible.git"
  DEPLOY_ANSIBLE_BRANCH: "master"
  DEPLOY_ANSIBLE_VENV: "/tmp/.venv/ansible"
  DEPLOY_ANSIBLE_ROOT_PATH: "/tmp/ansible"
  DEPLOY_ANSIBLE_VAULT_PATH: ".vault_magic.password"
  ANSIBLE_HOST_KEY_CHECKING: "False"
  DEPLOY_GROUP: "magic"
  DEPLOY_SSH_PRIVATE_KEY: "id_ed25519.pem"
  DEPLOY_PLAYBOOK: "lantern.yml"

  # Secrets (set in GitLab CI/CD settings)
  # - PROJECT_ACCESS_TOKEN
  #   - https://gitlab.data.bas.ac.uk/MAGIC/lantern-exp/-/settings/access_tokens
  #   - (name: 'gitlab_ci' scope: 'read_api', role: 'reporter')
  # - SAFETY_API_KEY
  #   - https://start.1password.com/open/i?a=QSB6V7TUNVEOPPPWR6G7S2ARJ4&v=k34cpwfkqaxp2r56u4aklza6ni&i=swbuhnii4ego6qycyqknvtk7gi&h=magic.1password.eu
  # - OP_SERVICE_ACCOUNT_TOKEN
  #   - https://magic.1password.eu/developer-tools/infrastructure-secrets/serviceaccount/4MR5NL7W45AA3GAFGRZMVN2H2I

image: mcr.microsoft.com/playwright/python:v1.57.0-noble

.before_script_python: &before_script_python
  # setup UV
  - curl -LsSfo uv.tar.gz https://github.com/astral-sh/uv/releases/download/$UV_VERSION/uv-x86_64-unknown-linux-gnu.tar.gz
  - tar -xzf uv.tar.gz
  - mv uv-x86_64-unknown-linux-gnu/uv uv-x86_64-unknown-linux-gnu/uvx /usr/local/bin
  - uv --version

.before_script_testing: &before_script_testing
  - *before_script_python

  # setup locale for playwright
  - apt-get update
  - apt-get install -y locales
  - sed -i 's/# en_GB.UTF-8 UTF-8/en_GB.UTF-8 UTF-8/' /etc/locale.gen
  - locale-gen
  - export LANG=en_GB.UTF-8
  - export LANGUAGE=en_GB:en
  - export LC_ALL=en_GB.UTF-8

  # Setup rsync for trusted publishing
  - apt-get install -y rsync

  # setup app deps
  - uv sync --frozen --all-groups --python $PYTHON_VERSION
  # start static site for e2e tests
  - python -m http.server 8123 --directory "$STATIC_SITE_PATH" &

.before_script_deploy: &before_script_deploy
  - apt-get update

  # setup 1Password CLI
  - apt-get install -y curl unzip
  - curl -sSfo op.zip https://cache.agilebits.com/dist/1P/op2/pkg/v2.32.0/op_linux_amd64_v2.32.0.zip
  - unzip -od /usr/local/bin/ op.zip

  # setup Ansible
  - apt-get install -y git ssh build-essential
  - git clone --branch $DEPLOY_ANSIBLE_BRANCH https://gitlab-ci-token:$CI_JOB_TOKEN@$DEPLOY_ANSIBLE_REPO $DEPLOY_ANSIBLE_ROOT_PATH
  - python -m venv $DEPLOY_ANSIBLE_VENV
  - $DEPLOY_ANSIBLE_VENV/bin/python -m pip install --upgrade pip
  - $DEPLOY_ANSIBLE_VENV/bin/python -m pip install -r $DEPLOY_ANSIBLE_ROOT_PATH/requirements.txt
  - export PATH=$DEPLOY_ANSIBLE_VENV/bin:$PATH

  # setup Ansible vault
  - op read --out-file ~/$DEPLOY_ANSIBLE_VAULT_PATH "op://Infrastructure/Ansible Vault - BAS IT Ansible MAGIC/password"

  # setup SSH
  - apt-get install -y openssh-client
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - op read --out-file ~/.ssh/$DEPLOY_SSH_PRIVATE_KEY "op://Infrastructure/SCAR ADD Metadata Toolbox - GitLab CI deploy private key/private key?ssh-format=openssh"
  - eval $(ssh-agent -s)
  - chmod 400 ~/.ssh/$DEPLOY_SSH_PRIVATE_KEY
  - ssh-add ~/.ssh/$DEPLOY_SSH_PRIVATE_KEY

# Jobs

pytest:
  stage: ðŸ§ª test
  needs: []
  before_script:
    - *before_script_testing
  script:
    - $TASK_BIN ci-test
  coverage: '/Total coverage: \d+\.\d+/'
  artifacts:
    when: always
    reports:
      junit: test-results.xml
    paths:
      - htmlcov
    expire_in: 1 month
  rules:
    -
      changes:
        - 'src/**/*.py'
        - 'tests/**/*.py'
        - 'pyproject.toml'
        - 'uv.lock'
      if: '$CI_COMMIT_BRANCH != "main" && $CI_COMMIT_TAG == null'

ty:
  stage: ðŸ“‹ lint
  needs: []
  before_script:
    - *before_script_python
  script:
    - $TASK_BIN types
  rules:
    -
      changes:
        - '**/*.py'
      if: '$CI_COMMIT_BRANCH != "main" && $CI_COMMIT_TAG == null'

ruff:
  stage: ðŸ“‹ lint
  needs: []
  before_script:
    - *before_script_python
  script:
    - $TASK_BIN lint
    - $TASK_BIN format --check
  rules:
    -
      changes:
        - '**/*.py'
      if: '$CI_COMMIT_BRANCH != "main" && $CI_COMMIT_TAG == null'

safety:
  stage: ðŸ“‹ lint
  needs: []
  before_script:
    - *before_script_python
  script:
    - $TASK_BIN ci-safety
  rules:
    -
      changes:
        - '.safety-policy.yml'
        - 'uv.lock'
      if: '$CI_COMMIT_BRANCH != "main" && $CI_COMMIT_TAG == null'

markdown:
  stage: ðŸ“‹ lint
  needs: []
  before_script:
    - *before_script_python
  script:
    - $TASK_BIN markdown
  rules:
    -
      changes:
        - 'README.md'
        - 'docs/**/*.md'
      if: '$CI_COMMIT_BRANCH != "main" && $CI_COMMIT_TAG == null'

build:
  stage: ðŸ— build
  needs: []
  before_script:
    - *before_script_python
  script:
    - $TASK_BIN build
  artifacts:
    paths:
      - dist/
    expire_in: 1 month
  rules:
    -
      changes:
        - '**/*.py'
        - 'pyproject.toml'
        - 'uv.lock'
      if: '$CI_COMMIT_BRANCH != "main" || $CI_COMMIT_TAG != null'

publish:
  stage: ðŸ“¦ publish
  needs:
    - job: build
      artifacts: true
  before_script:
    - *before_script_python
  script:
    - uv publish --index=self --username=gitlab-ci-token --password=$CI_JOB_TOKEN
  retry:
    max: 2
  rules:
    - if: '$CI_COMMIT_TAG != null'

prerelease:
  stage: ðŸ“¦ publish
  needs: []
  before_script:
    - *before_script_python
    - uv sync --frozen --group=dev --python $PYTHON_VERSION
    - $TASK_BIN release prerelease
    - TASK_CMD=($TASK_BIN)
    - echo "DEPLOY_APP_VERSION=$("${TASK_CMD[@]}" version)" >> build.env
  script:
    - $TASK_BIN build
    - uv publish --index=self --username=gitlab-ci-token --password=$CI_JOB_TOKEN
  retry:
    max: 2
  artifacts:
    reports:
      dotenv: build.env
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_COMMIT_TAG == null'

deploy_stage:
  stage: ðŸš€ deploy
  needs:
    - job: prerelease
      artifacts: true
  image: python:3.6-slim
  variables:
    DEPLOY_ENV: "staging"
  before_script:
    - *before_script_deploy
  script:
    - cd $DEPLOY_ANSIBLE_ROOT_PATH
    - ansible workstations -m ping -i inventory/$DEPLOY_GROUP/$DEPLOY_ENV
    - ansible-playbook -v -b -e env=$DEPLOY_ENV -e group=$DEPLOY_GROUP -e project=$DEPLOY_ANSIBLE_ROOT_PATH -e app_version=$DEPLOY_APP_VERSION --vault-id ~/$DEPLOY_ANSIBLE_VAULT_PATH -i inventory/$DEPLOY_GROUP/$DEPLOY_ENV playbooks/$DEPLOY_GROUP/$DEPLOY_PLAYBOOK
  environment:
    name: staging
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_COMMIT_TAG == null'
  when: manual

deploy_prod:
  stage: ðŸš€ deploy
  needs:
    - job: publish
  image: python:3.6-slim
  variables:
    DEPLOY_ENV: "production"
  before_script:
    - *before_script_deploy
    - export DEPLOY_APP_VERSION=$(echo $CI_COMMIT_TAG | cut -c 2-)  # remove 'v' prefix
  script:
    - cd $DEPLOY_ANSIBLE_ROOT_PATH
    - ansible workstations -m ping -i inventory/$DEPLOY_GROUP/$DEPLOY_ENV
    - ansible-playbook -v -b -e env=$DEPLOY_ENV -e group=$DEPLOY_GROUP -e project=$DEPLOY_ANSIBLE_ROOT_PATH -e app_version=$DEPLOY_APP_VERSION --vault-id ~/$DEPLOY_ANSIBLE_VAULT_PATH -i inventory/$DEPLOY_GROUP/$DEPLOY_ENV playbooks/$DEPLOY_GROUP/$DEPLOY_PLAYBOOK
  environment:
    name: production
  rules:
    - if: $CI_COMMIT_TAG

gitlab_release:
  stage: ðŸ“£ release
  needs:
    - job: publish
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  before_script:
    - apk add --no-cache curl jq

    - export TAG_NO_PREFIX=$(echo $CI_COMMIT_TAG | cut -c 2-)
    # for a string v0.8.13, replace last digit to always be 0
    - export TAG_NO_PATCH=$(echo $CI_COMMIT_TAG | sed 's/[0-9]$/0/')

    - 'curl -s -H "Authorization: Bearer $PROJECT_ACCESS_TOKEN" "$CI_API_V4_URL/projects/$CI_PROJECT_ID/packages" > data.json'
    - export PACKAGE_ID=$(cat data.json | jq -r ".[] | select(.version==\"$TAG_NO_PREFIX\") | .id") && rm data.json

    - 'curl -s -H "Authorization: Bearer $PROJECT_ACCESS_TOKEN" "$CI_API_V4_URL/projects/$CI_PROJECT_ID/milestones?title=$CI_COMMIT_TAG" > milestone_exact.json'
    - 'curl -s -H "Authorization: Bearer $PROJECT_ACCESS_TOKEN" "$CI_API_V4_URL/projects/$CI_PROJECT_ID/milestones?title=$TAG_NO_PATCH" > milestone-minor.json'
    - export MILESTONE_TITLE_EXACT=$(cat milestone_exact.json | jq -r ".[0] | .title") && rm milestone_exact.json
    - export MILESTONE_TITLE_MINOR=$(cat milestone-minor.json | jq -r ".[0] | .title") && rm milestone-minor.json
    - >
      if [ "$MILESTONE_TITLE_EXACT" != "null" ]; then
          export MILESTONE_TITLE=$MILESTONE_TITLE_EXACT
      elif [ "$MILESTONE_TITLE_MINOR" != "null" ]; then
          export MILESTONE_TITLE=$MILESTONE_TITLE_MINOR
      else
          export MILESTONE_TITLE=""
      fi

    - curl -s -L -O https://github.com/taiki-e/parse-changelog/releases/download/v0.6.8/parse-changelog-x86_64-unknown-linux-musl.tar.gz
    - tar -xzf parse-changelog-x86_64-unknown-linux-musl.tar.gz -C /usr/local/bin/
    - parse-changelog CHANGELOG.md "$TAG_NO_PREFIX" > changelog.txt

    # the release section cannot access variables defined in a script but can read from a file :|
    - echo "$TAG_NO_PREFIX" > tag_no_prefix.txt
    - echo "$PACKAGE_ID" > package_id.txt
    - echo "$MILESTONE_TITLE" > milestone_title.txt
  script:
    - echo 'releasing'
  release:
    name: $(cat tag_no_prefix.txt)
    tag_name: $CI_COMMIT_TAG
    milestones:
      - $(cat milestone_title.txt)
    description: $(cat changelog.txt)
    assets:
      links:
        - name: README
          url: '$CI_PROJECT_URL/-/blob/$CI_COMMIT_TAG/README.md'
          link_type: runbook
        - name: Python Package
          url: '$CI_PROJECT_URL/-/packages/$(cat package_id.txt)'
          link_type: package
  rules:
    - if: $CI_COMMIT_TAG

# TODO: github_release
