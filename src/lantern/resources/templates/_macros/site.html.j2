{% import '_macros/common.html.j2' as com %}

{# tuples of ('label', 'href', 'icon class') #}
{% set primary_nav_items = [] %}

{# dict of tuple lists of ('href', 'label', 'external', 'restricted' #}
{% set
  footer_nav_items = {
    'Discover': [('https://www.bas.ac.uk/maps', 'Maps', false, false)],
    'Portals': [
      ('https://www.icelogistics.info', 'Ice Logistics Portal', true, false),
      ('https://opsgis.web.bas.ac.uk/login', 'Operations GIS', true, true)
     ],
    'Guides': [
      ('https://guides.geospatial.bas.ac.uk', 'Geospatial training', true, false),
      ('https://metadata-standards.data.bas.ac.uk', 'Metadata standards', true, false),
      ('/guides/formatting', 'Content formatting', false, false),
      ('/guides/api', 'API documentation', false, false)
    ],
    'About': [
      ('https://gitlab.data.bas.ac.uk/MAGIC/lantern-exp', 'GitLab project', true, true),
      ('https://github.com/antarctica/lantern', 'GitHub mirror', true, false)
    ]
  }
%}

{% macro html_head(data) %}
  <head>
    {{ head_meta(data) }}
    {{ head_title(data.html_title_suffixed) }}
    {% if data.html_open_graph_tags %}
      {{ head_open_graph(data.html_open_graph_tags) }}
    {% endif %}
    {{ head_favicon(data.build_key) }}
    {{ head_api_catalogue() }}
    {{ head_styles(data.build_key) }}
    {{ head_scripts(data) }}
  </head>
{% endmacro %}

{% macro head_meta(data) %}
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="{{ data.generator }}">
  <meta name="version" content="{{ data.version }}">
  <meta name="generated" content="{{ data.build_time.isoformat() }}">
  {% if data.build_ref %}<meta name="store-ref" content="{{ data.build_ref.value }}">{% endif %}
  {% if data.html_description %}<meta name="description" content="{{ data.html_description }}">{% endif %}
{% endmacro %}

{% macro head_title(value) %}
  <title>{{ value }}</title>
{% endmacro %}

{% macro head_open_graph(data) %}
  {% for property, content in data | items %}
    <meta property="{{ property }}" content="{{ content }}" />
  {% endfor %}
{% endmacro %}

{% macro head_favicon(build_key) %}
  <link fetchpriority="low" rel="shortcut icon" href="/static/img/favicon.ico?v={{ build_key }}" />
  <link fetchpriority="low" rel="icon" href="/static/img/favicon.svg?v={{ build_key }}" type="image/svg+xml">
  <link fetchpriority="low" rel="apple-touch-icon" href="/static/img/apple-touch-icon.png?v={{ build_key }}" sizes="180x180" />
  <link fetchpriority="low" rel="manifest" href="/static/txt/manifest.webmanifest?v={{ build_key }}" />
{% endmacro %}

{% macro head_api_catalogue(build_key) %}
  <link fetchpriority="low" rel="api-catalog" href="/static/json/api-catalog.json">
{% endmacro %}

{% macro head_styles(build_key) %}
  {{ styles_font_awesome() }}
  <link rel="stylesheet" href="/static/css/main.css?v={{ build_key }}" />
{% endmacro %}

{% macro styles_font_awesome() %}
  <link rel="stylesheet" href="https://kit.fontawesome.com/032ef5c342.css" crossorigin="anonymous">
{% endmacro %}

{% macro head_scripts(data) %}
  {{ script_sentry(data.build_key) }}
  {{ script_plausible(data.plausible_domain) }}
  {{ script_turnstile() }}
  {{ script_enhancements(data.build_key) }}
  {% if data.html_schema_org_content %}
    {{ script_schema_org(data.html_schema_org_content) }}
  {% endif %}
{% endmacro %}

{% macro script_sentry(build_key) %}
  <script defer src="/static/js/sentry-preload.js?v={{ build_key }}" crossorigin="anonymous"></script>
  <script defer src="/static/js/lib/sentry.min.js?v={{ build_key }}" crossorigin="anonymous"></script>
{% endmacro %}

{% macro script_plausible(value) %}
  <script defer data-domain="{{ value }}" src="https://plausible.io/js/script.hash.outbound-links.js"></script>
{% endmacro %}

{% macro script_turnstile() %}
  <script defer async src="https://challenges.cloudflare.com/turnstile/v0/api.js"></script>
{% endmacro %}

{% macro script_enhancements(build_key) %}
  <script defer src="/static/js/enhancements.js?v={{ build_key }}"></script>
{% endmacro %}

{% macro script_schema_org(value) %}
  <script rel="alternate" type="application/ld+json">
{{ value }}
  </script>
{% endmacro %}

{% macro primary_nav() %}
  {% for item in primary_nav_items %}
    <a class="hover:underline" href="{{ item[1] }}"><i class="{{ item[2] }}"></i> {{ item[0] }}</a>
  {% endfor %}
{% endmacro %}

{% macro top_anchor() %}
  <div id="{{ com.back_to_top_id() }}"></div>
{% endmacro %}

{% macro header(data) %}
  <header id="site-header" class="space-y-4">
    {{ navbar() }}
    {{ dev_phase(data.fallback_email) }}
  </header>
{% endmacro %}

{% macro navbar() %}
  <nav id="site-nav" class="lg:p-4 bg-grey-950 dark:bg-black text-white">
    <div class="{{ com.container_classes() }} py-4 lg:flex lg:gap-8 lg:justify-between lg:items-end">
      <div class="flex-none flex justify-center lg:justify-start items-center">
        <a id="site-title" class="block font-bold text-lg text-center lg:text-left" href="/">BAS Data Catalogue</a>
      </div>
      <div class="flex-1 hidden lg:flex items-center gap-4 justify-start">
        {{ primary_nav() }}
      </div>
      <div class="flex-1 flex self-center justify-end">
        <a class="hidden lg:block hover:underline" href="https://www.bas.ac.uk">Part of British Antarctic Survey</a>
      </div>
    </div>
  </nav>
{% endmacro %}

{% macro dev_phase(fallback_email) %}
  <div id="site-dev" class="{{ com.container_classes() }} px-2 space-x-2">
    <span id="site-dev-phase" class="uppercase text-sm font-bold bg-pink-500 text-white dark:text-grey-950 py-1 px-2">alpha</span>
    <span>
      This is a new website, your {{ com.feedback_trigger(classes=com.link_classes(), fallback=fallback_email, text='feedback') }}
      will help us to improve it.
    </span>
  </div>
{% endmacro %}

{% macro feedback_widget(fallback_email) %}
  <form
    id="{{ com.feedback_widget_target() }}"
    class="hidden fixed bottom-4 right-4 w-80 mb-0 p-4 text-sm space-y-4 {{ com.base_bg_text_classes() }} shadow-lg border border-grey-300 dark:border-grey-500"
  >
    <header class="flex items-center justify-between">
      <h2 class="text-lg">Send feedback</h2>
      <button
        class="{{ com.btn_base_classes() }} text-grey-500 dark:text-grey-300 hover:text-grey-700"
        data-target="#{{ com.feedback_widget_target() }}"
      >
        <i class="fa-regular fa-xmark fa-lg"></i>
      </button>
    </header>
    <div class="space-y-2">
      {{ com.form_textarea(
        id="feedback-content", name="Message", rows=4, required=True, warning="Do not include any sensitive information."
      ) }}
      {{ com.form_input(id="feedback-email", name="Contact email (optional)") }}
    </div>
    <footer class="space-y-2">
      {% call com.alert(variant='blue') %}
        <p>Basic device information will be included with your feedback.
          See our <a class="{{ com.link_classes() }}" href="/legal/privacy">privacy policy</a> for more information.</p>
      {% endcall %}
      <button class="{{ com.btn_primary_classes() }} w-full p-4 text-base" type="submit">
        Send Feedback <i class="fa-regular fa-paper-plane-top"></i>
      </button>
    <div id="feedback-success" class="hidden">
      {% call com.alert(variant='green') %}
        <p>Thank you for your feedback!</p>
      {% endcall %}
    </div>
    <div id="feedback-error" class="hidden">
      {% call com.alert(variant='red', classes='space-y-2') %}
        <p>Error sending feedback.</p>
        <p>Please try again later or <a class="{{ com.link_classes() }}" href="mailto:{{ fallback_email }}">contact us</a>.</p>
        <p>If you are using an ad-blocker, please ensure Sentry is allowed.</p>
      {% endcall %}
    </div>
    </footer>
  </form>
{% endmacro %}

{% macro footer(data) %}
  <footer id="site-footer" class="font-light bg-grey-950 dark:bg-black text-grey-100 text-center">
    <div class="{{ com.container_classes() }} px-2 py-8 space-y-4 lg:space-y-8">
      {{ footer_basics(data.fallback_email) }}
      {{ footer_nav() }}
      {{ footer_primary_nav() }}
      {{ footer_legal(data.build_time.year) }}
      {{ footer_network_nav() }}
    </div>
  </footer>
{% endmacro %}

{% macro footer_basics(fallback_email) %}
  <div class="flex flex-col justify-between space-y-4 lg:space-y-0 lg:flex-row">
    {{ com.feedback_trigger(classes=com.footer_link_classes(), fallback=fallback_email, text='Is something wrong with this page?') }}
    <a class="{{ com.footer_link_classes() }} lg:text-right" href="#{{ com.back_to_top_id() }}">
      Back to top <i class="fa-regular fa-arrow-up"></i>
    </a>
  </div>
{% endmacro %}

{% macro footer_nav() %}
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 lg:text-left">
    {% for section_title, link in footer_nav_items.items() %}
    <section class="space-y-4">
      <h4>{{ section_title }}</h4>
      <ul class="space-y-2">
        {% for link in link %}
          <li>
            <a class="{{ com.footer_link_classes() }}" href="{{ link[0] }}">
              {{ link[1] }}{% if link[2] %} {{ com.ext_link_i() }}{% endif %}{% if link[3] %}{{ com.restricted_i() }}{% endif %}
            </a>
          </li>
        {% endfor %}
      </ul>
    </section>
    {% endfor %}
  </div>
{% endmacro %}

{% macro footer_primary_nav() %}
  <div class="block lg:hidden flex justify-center justify-between {{ com.footer_link_classes() }}">
    {{ primary_nav() }}
  </div>
{% endmacro %}

{% macro footer_legal(copyright_year) %}
  <div class="flex flex-col justify-between space-y-4 lg:space-y-0 lg:flex-row">
    <div class="lg:text-left lg:flex lg:space-x-2">
      <p>Â© <a class="{{ com.footer_link_classes() }}" href="https://www.bas.ac.uk">British Antarctic Survey</a> {{ copyright_year }}<span class="hidden lg:inline">.</span></p>
    </div>
    <ul class="flex justify-center space-x-2 lg:justify-end">
      <li><a class="{{ com.footer_link_classes() }}" href="/legal/accessibility">Accessibility</a></li>
      <li><a class="{{ com.footer_link_classes() }}" href="/legal/cookies">Cookies</a></li>
      <li><a class="{{ com.footer_link_classes() }}" href="/legal/copyright">Copyright</a></li>
      <li><a class="{{ com.footer_link_classes() }}" href="/legal/privacy">Privacy</a></li>
    </ul>
  </div>
{% endmacro %}

{% macro footer_network_nav() %}
  <a class="block lg:hidden {{ com.footer_link_classes() }}" target="_blank" href="https://www.bas.ac.uk">Part of British Antarctic Survey {{ com.ext_link_i() }}</a>
{% endmacro %}
